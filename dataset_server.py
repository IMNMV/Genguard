# /// script
# dependencies = ["mcp"]
# ///
"""
dataset_server.py
An MCP Server that implements the Agentic Active Validator Framework.
"""

from mcp.server.fastmcp import FastMCP
import dataset_guard
import dataset_append
import sys
import io
import contextlib
from typing import Dict

# Initialize Server
mcp = FastMCP("Agentic Data Curator", dependencies=["mcp"])

def dict_to_pairs(data: Dict[str, str]) -> list[str]:
    """Helper to convert dictionary to CLI args."""
    return [f"{k}={v}" for k, v in data.items()]

@mcp.tool()
def save_generated_data(
    target_file: str, 
    check_col: str, 
    data: Dict[str, str], 
    threshold: float = 0.78
) -> str:
    """
    Validates and saves a piece of data generated by the Agent.
    
    This tool acts as a quality gate. It compares the 'data' you generated 
    against the existing 'target_file'.
    
    - If the data is UNIQUE: It is saved to the CSV.
    - If the data is a DUPLICATE (or too similar): It returns an ERROR 
      containing the similar existing text. You must then generate a 
      new, unique variant.
      
    Args:
        target_file: Path to the CSV (e.g., 'dataset.csv')
        check_col: The column to check for duplicates (e.g., 'text')
        data: The dictionary of data to save (e.g., {'text': '...', 'label': '...'})
        threshold: Similarity threshold (0.0-1.0). Default 0.78.
    """
    
    # Prepare arguments for the Guard script
    pairs = dict_to_pairs(data)
    guard_args = [
        "--file", target_file,
        "--check-col", check_col,
        "--threshold", str(threshold)
    ] + pairs

    # 1. RUN THE GUARD (Active Validation)
    guard_output = io.StringIO()
    try:
        # Capture stdout so the Agent sees the "Existing: ..." text if rejected
        with contextlib.redirect_stdout(guard_output), contextlib.redirect_stderr(guard_output):
            exit_code = dataset_guard.main(guard_args)
    except SystemExit as e:
        exit_code = e.code if isinstance(e.code, int) else 1
    except Exception as e:
        raise RuntimeError(f"System Error running guard: {str(e)}")

    output_text = guard_output.getvalue()

    if exit_code != 0:
        # RETURN THE REJECTION AS AN ERROR
        # The output_text contains the "Existing: {text}" line from dataset_guard.py
        # This ensures the Agent sees exactly what it collided with.
        raise ValueError(f"VALIDATION FAILED:\n{output_text}")

    # 2. SAVE THE DATA (Only if Guard passed)
    append_args = ["--file", target_file, "--add-timestamp"] + pairs
    
    append_output = io.StringIO()
    try:
        with contextlib.redirect_stdout(append_output), contextlib.redirect_stderr(append_output):
            dataset_append.main(append_args)
    except SystemExit:
        pass 
    except Exception as e:
        raise RuntimeError(f"Error writing to file: {e}")

    return f"Success. {append_output.getvalue().strip()}"

if __name__ == "__main__":
    mcp.run()
